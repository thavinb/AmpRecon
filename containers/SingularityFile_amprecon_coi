# Copyright (C) 2023 Genome Surveillance Unit/Genome Research Ltd.

Bootstrap: docker
# Potentailly change to more stable version 24.04 LTS in the future
From:ubuntu:23.04

%post
export DEBIAN_FRONTEND=noninteractive

# The link to repository of 23.04 is already archive to old-release.
sed -i -E 's#^(deb(-src)?\s+)https?://security\.ubuntu\.com/ubuntu#\1http://old-releases.ubuntu.com/ubuntu#g' /etc/apt/sources.list
sed -i -E 's#^(deb(-src)?\s+)https?://[a-zA-Z0-9.-]*archive\.ubuntu\.com/ubuntu#\1http://old-releases.ubuntu.com/ubuntu#g' /etc/apt/sources.list

apt update
apt upgrade -y
apt install gcc git grep libcurl4-openssl-dev r-base build-essential python3 -y

# get TheRealMcCoil code
mkdir /app/
cd /app/
git clone https://github.com/AMarinhoSN/THEREALMcCOIL.git
cd THEREALMcCOIL/

# install library here
# The previous specify repo do not work. 
# Change to automatically find the repo
Rscript -e 'install.packages("optparse")'
Rscript -e 'install.packages("here")'
Rscript -e 'install.packages("this.path")'

# compile cartegorical method
cd categorical_method/
R CMD SHLIB McCOIL_categorical_code.c llfunction_het.c
# update path on the testing script
sed -i '1s/.*/path="\/app\/THEREALMcCOIL\/categorical_method\/"/' test_R_code.R

# recompile proportional method
cd ../proportional_method/
R CMD SHLIB McCOIL_prop_code.c llfunction.c
sed -i '1s/.*/path="\/app\/THEREALMcCOIL\/proportional_method\/"/' test_R_code.R

%runscript
exec /bin/bash "$@"

%startscript
exec /bin/bash "$@"
